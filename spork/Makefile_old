# Makefile - Simplified (no Primer)
CC = gcc
CFLAGS = -Wall -Wextra -O2 -fPIC -D_GNU_SOURCE
LDFLAGS = -ldl

SPORK_OBJS = spork.o facade.o ufork.o

all: libspork.so test_spork

libspork.so: $(SPORK_OBJS)
	$(CC) -shared -o libspork.so $(SPORK_OBJS) $(LDFLAGS)

test_spork: test_spork.c libspork.so spork.h
	$(CC) $(CFLAGS) -o test_spork test_spork.c -L. -lspork -Wl,-rpath,.

spork.o: spork.c spork.h
	$(CC) $(CFLAGS) -c spork.c -o spork.o

facade.o: facade.c spork.h
	$(CC) $(CFLAGS) -c facade.c -o facade.o

ufork.o: ufork.c spork.h
	$(CC) $(CFLAGS) -c ufork.c -o ufork.o

clean:
	rm -f *.o *.so test_spork /tmp/spork_primer_*

run: all
	@echo "=========================================="
	@echo "Running Spork Test Suite"
	@echo "=========================================="
	@LD_PRELOAD=./libspork.so ./test_spork

.PHONY: all clean run